# Request history (RFC-002)

![](https://img.shields.io/badge/status-draft-orange.svg)

## Overview

This RFC proposes adding request history functionality to nock, allowing users to access and assert against the details of intercepted requests (headers, body, URL, etc.) in their tests.

## Use Case

```js
it('should create a new user', async () => {
  const scope = nock('https://userservice.com/user')
    .post('/')
    .reply(201, { id: 1, name: 'Bob' }, { 'content-type': 'application/json' })
  
  const response = await fetch('https://userservice.com/user', {
    method: 'POST',
    body: JSON.stringify({ name: 'Bob' }),
    headers: { 'Content-Type': 'application/json' }
  })

  expect(response.status).toBe(201)
  
  // Access the intercepted request
  const request = scope.requests[0]
  
  // Assert on request properties
  expect(await request.json()).toEqual({ name: 'Bob' })
  expect(request.headers.get('content-type')).toBe('application/json')
})
```

## API

### Core Features

* Following the patterns established in popular mock libraries like Jest and Vitest, we propose exposing intercepted requests via a `requests` property.
* This property will contain an array of `Request` instances, compatible with the Fetch API.
* We **may** add helper functions to search for specific requests:

```js
// Access the first request matching a specific path
const request = scope.requests.firstCall({ path: '/path' })

// Access the last request matching specific criteria
const lastRequest = scope.requests.lastCall({ method: 'POST' })

// Filter requests by criteria
const postRequests = scope.requests.filter({ method: 'POST' })

// Get request count matching criteria
const count = scope.requests.count({ path: '/users' })
```

## Implementation Details

### Memory Considerations

Based on PR discussions, we need to be mindful of memory usage. Some considerations:

1. By default, we store a limited amount of requests.
2. We **may** provide a method to change this limit.
3. Add a method to clear request history (similar to Jest's `mockClear()`)

Example implementation:

```js
nock.maxHistoryLog = 10 // global
const scope = nock('https://api.example.com', { maxHistoryLog: 20 })
  .get('/users')
  .reply(200, [...])

// Later, clear the request history if needed
scope.clearRequestHistory()
```

## Open Questions

1. Should the request history property (`requests`) be on the scope level, interceptor level, or both?
   Side note: I must say that I'm not entirely understand why `nock` creates `scope` to begin with and not just interceptors.

2. Should we roll this out with an `experimental` flag to allow for API adjustments based on user feedback?

3. Should we use the standard Fetch API `Request` object or a custom object with relevant properties?
   - Using `Request` provides consistency with web standards
   - A custom object might be more efficient or provide nock-specific functionality

4. Should there be a global configuration option to set memory limits for request history?

## Other Mocking APIs

- [Jest Mock Functions](https://jestjs.io/docs/mock-function-api) - Uses `.mock.calls` to track call history
- [Sinon](https://sinonjs.org/) - Provides methods like `getCalls()`, `firstCall`, `lastCall`, etc.
- [Undici](https://github.com/nodejs/undici/blob/main/docs/docs/best-practices/mocking-request.md) - Node.js HTTP/1.1 client with mocking capabilities

## References

- [#2171](https://github.com/nock/nock/issues/2171) - Original feature request
- [#2750](https://github.com/nock/nock/pull/2750) - Implementation PR